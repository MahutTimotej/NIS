@using Microsoft.EntityFrameworkCore.Metadata
@using System.Globalization

<div class="mb-2">
    <label class="form-label fw-semibold">@Property.Name</label>

    @if (!string.IsNullOrWhiteSpace(Hint))
    {
        <div class="small text-muted mb-1">@Hint</div>
    }

    @if (_u == typeof(bool))
    {
        <input class="form-check-input" type="checkbox" disabled="@ReadOnly"
               checked="@GetBool()" @onchange="OnBoolChanged" />
    }
    else if (_u == typeof(DateTime))
    {
        <input class="form-control" type="datetime-local" disabled="@ReadOnly"
               value="@GetDateTimeLocal()" @onchange="OnTextChanged" />
    }
    else if (_u == typeof(int) || _u == typeof(long) || _u == typeof(short))
    {
        <input class="form-control" type="number" disabled="@ReadOnly"
               value="@GetString()" @onchange="OnTextChanged" />
    }
    else if (_u == typeof(decimal) || _u == typeof(double) || _u == typeof(float))
    {
        <input class="form-control" type="text" disabled="@ReadOnly"
               value="@GetString()" @onchange="OnTextChanged" placeholder="napr. 12.5" />
    }
    else
    {
        <input class="form-control" type="text" disabled="@ReadOnly"
               value="@GetString()" @onchange="OnTextChanged" />
    }
</div>

@code {
    [Parameter, EditorRequired] public object Model { get; set; } = default!;
    [Parameter, EditorRequired] public IProperty Property { get; set; } = default!;
    [Parameter] public bool ReadOnly { get; set; }
    [Parameter] public string? Hint { get; set; }

    private Type _u => Nullable.GetUnderlyingType(Property.ClrType) ?? Property.ClrType;

    private string GetString()
    {
        try
        {
            var v = Property.PropertyInfo?.GetValue(Model);
            return v?.ToString() ?? "";
        }
        catch { return ""; }
    }

    private bool GetBool()
    {
        try
        {
            var v = Property.PropertyInfo?.GetValue(Model);
            return v is bool b && b;
        }
        catch { return false; }
    }

    private string GetDateTimeLocal()
    {
        try
        {
            var v = Property.PropertyInfo?.GetValue(Model);
            if (v is DateTime dt)
            {
                var local = dt;
                return local.ToString("yyyy-MM-ddTHH:mm", CultureInfo.InvariantCulture);
            }
        }
        catch { }
        return "";
    }

    private void OnBoolChanged(ChangeEventArgs e)
    {
        if (ReadOnly) return;
        try
        {
            var b = e.Value?.ToString() == "true";
            Property.PropertyInfo?.SetValue(Model, b);
        }
        catch { }
    }

    private void OnTextChanged(ChangeEventArgs e)
    {
        if (ReadOnly) return;

        var s = e.Value?.ToString() ?? "";
        try
        {
            object? value = null;

            if (_u == typeof(string)) value = s;
            else if (_u == typeof(int) && int.TryParse(s, out var i)) value = i;
            else if (_u == typeof(long) && long.TryParse(s, out var l)) value = l;
            else if (_u == typeof(short) && short.TryParse(s, out var sh)) value = sh;
            else if (_u == typeof(decimal) && decimal.TryParse(s, NumberStyles.Any, CultureInfo.InvariantCulture, out var dec)) value = dec;
            else if (_u == typeof(double) && double.TryParse(s, NumberStyles.Any, CultureInfo.InvariantCulture, out var dbl)) value = dbl;
            else if (_u == typeof(float) && float.TryParse(s, NumberStyles.Any, CultureInfo.InvariantCulture, out var flt)) value = flt;
            else if (_u == typeof(DateTime) && DateTime.TryParse(s, CultureInfo.InvariantCulture, DateTimeStyles.AssumeLocal, out var dt)) value = dt;
            else value = null;

            if (value is null && Nullable.GetUnderlyingType(Property.ClrType) is null && _u != typeof(string))
                return;

            Property.PropertyInfo?.SetValue(Model, value);
        }
        catch { }
    }
}
