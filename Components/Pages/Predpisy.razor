@page "/predpisy"
@rendermode InteractiveServer

@using Microsoft.EntityFrameworkCore
@using NIS.Data
@using NIS.Data.Models
@using NIS.Services

@inject IDbContextFactory<NisDbContext> DbFactory
@inject NotificationService Notify

<h2 class="mb-3">Predpisy</h2>

<Alert />

<div class="card-nis mb-3">
    <div class="card-header fw-semibold">
        @(_isEdit ? "Úprava predpisu" : "Nový predpis")
    </div>

    <div class="card-body">
        <EditForm Model="_edit" OnValidSubmit="SaveAsync">
            <DataAnnotationsValidator />

            <div class="row g-3">

                <div class="col-md-2">
                    <InputNumber class="form-control"
                                 placeholder="ID vyšetrenia"
                                 @bind-Value="_edit.IdVysetrenia" />
                </div>

                <!-- SUKL lazy search -->
                <div class="col-md-4 position-relative">
                    <InputText class="form-control"
                               placeholder="SUKL kód alebo názov lieku"
                               @bind-Value="_suklSearch"
                               @oninput="OnSuklInput" />

                    @if (_suklResults.Any())
                    {
                        <div class="list-group position-absolute w-100 shadow"
                             style="z-index:2000; max-height:260px; overflow:auto;">
                            @foreach (var l in _suklResults)
                            {
                                <button type="button"
                                        class="list-group-item list-group-item-action"
                                        @onclick="() => SelectSukl(l)">
                                    <strong>@l.SUKL_KOD</strong> – @l.NAZOV
                                </button>
                            }
                        </div>
                    }
                </div>

                <div class="col-md-2">
                    <InputText class="form-control"
                               placeholder="Dávkovanie"
                               @bind-Value="_edit.Davkovanie" />
                </div>

                <div class="col-md-2">
                    <InputText class="form-control"
                               placeholder="Množstvo"
                               @bind-Value="_edit.Mnozstvo" />
                </div>

                <div class="col-md-2">
                    <InputDate class="form-control"
                               @bind-Value="_edit.Datum" />
                </div>

                <div class="col-md-12">
                    <InputText class="form-control"
                               placeholder="Poznámka"
                               @bind-Value="_edit.Poznamka" />
                </div>
            </div>

            <div class="mt-3 d-flex gap-2">
                <button class="btn nis-btn btn-nis-primary" type="submit">
                    Uložiť
                </button>

                @if (_isEdit)
                {
                    <button class="btn nis-btn btn-nis-outline"
                            type="button"
                            @onclick="CancelEdit">
                        Zrušiť
                    </button>
                }
            </div>
        </EditForm>
    </div>
</div>

<NisTable @key="_tableKey"
          TItem="PredpisRow"
          Title="Zoznam predpisov"
          SearchPlaceholder="Hľadať (ID, vyšetrenie, SUKL, liek)..."
          PageSize="50"
          Colspan="8"
          Query="Query"
          Filter="Filter"
          Sort="Sort"
          DefaultSortCol="@nameof(PredpisRow.Datum)"
          DefaultSortAsc="false">

    <Header>
    <th>ID</th>
    <th>Vyšetrenie</th>
    <th>SUKL</th>
    <th>Liek</th>
    <th>Dátum</th>
    <th>Dávkovanie</th>
    <th>Množstvo</th>
    <th>Akcie</th>
    </Header>

    <Row Context="p">
        <tr>
            <td>@p.Id</td>
            <td>@p.IdVysetrenia</td>
            <td>@p.SuklKod</td>
            <td>@p.Liek</td>
            <td>@p.Datum.ToString("dd.MM.yyyy")</td>
            <td>@p.Davkovanie</td>
            <td>@p.Mnozstvo</td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1"
                        @onclick="() => EditAsync(p.Id)">
                    Edit
                </button>
                <button class="btn btn-sm btn-danger"
                        @onclick="() => DeleteAsync(p.Id)">
                    X
                </button>
            </td>
        </tr>
    </Row>
</NisTable>

@code {

    private int _tableKey;
    private bool _isEdit;

    private string _suklSearch = "";
    private List<N_LIEK> _suklResults = new();

    private PredpisEdit _edit = new() { Datum = DateTime.Today };

    private sealed class PredpisEdit
    {
        public decimal Id { get; set; }
        public decimal IdVysetrenia { get; set; }
        public string? SuklKod { get; set; }
        public string? Davkovanie { get; set; }
        public string? Mnozstvo { get; set; }
        public string? Poznamka { get; set; }
        public DateTime Datum { get; set; }
    }

    private sealed class PredpisRow
    {
        public decimal Id { get; set; }
        public decimal IdVysetrenia { get; set; }
        public string? SuklKod { get; set; }
        public string? Liek { get; set; }
        public DateTime Datum { get; set; }
        public string? Davkovanie { get; set; }
        public string? Mnozstvo { get; set; }
    }

    /* lazy SUKL lookup */
    private async Task OnSuklInput(ChangeEventArgs e)
    {
        var text = _suklSearch?.Trim();
        _suklResults.Clear();

        if (string.IsNullOrWhiteSpace(text) || text.Length < 2)
            return;

        await using var db = await DbFactory.CreateDbContextAsync();

        _suklResults = await db.N_LIEKs.AsNoTracking()
            .Where(x =>
                EF.Functions.Like(x.SUKL_KOD, $"%{text}%") ||
                EF.Functions.Like(x.NAZOV.ToUpper(), $"%{text.ToUpper()}%"))
            .OrderBy(x => x.NAZOV)
            .Take(20)
            .ToListAsync();
    }

    private void SelectSukl(N_LIEK l)
    {
        _edit.SuklKod = l.SUKL_KOD;
        _suklSearch = $"{l.SUKL_KOD} – {l.NAZOV}";
        _suklResults.Clear();
    }

    IQueryable<PredpisRow> Query(NisDbContext db)
        => db.N_PREDPIs.AsNoTracking()
            .Select(p => new PredpisRow
            {
                Id = p.ID_PREDPISU,
                IdVysetrenia = p.ID_VYSETRENIA,
                SuklKod = p.SUKL_KOD,
                Liek = p.SUKL_KODNavigation.NAZOV,
                Datum = p.DATUM_PREDPISU,
                Davkovanie = p.DAVKOVANIE,
                Mnozstvo = p.MNOZSTVO
            });

    IQueryable<PredpisRow> Filter(IQueryable<PredpisRow> q, string t)
    {
        var s = t.ToUpper();
        return q.Where(x =>
            EF.Functions.Like(x.Id.ToString(), $"%{t}%") ||
            EF.Functions.Like(x.IdVysetrenia.ToString(), $"%{t}%") ||
            EF.Functions.Like((x.SuklKod ?? "").ToUpper(), $"%{s}%") ||
            EF.Functions.Like((x.Liek ?? "").ToUpper(), $"%{s}%")
        );
    }

    IQueryable<PredpisRow> Sort(IQueryable<PredpisRow> q, string c, bool a)
        => q.OrderByDescending(x => x.Datum);

    private async Task SaveAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        if (_isEdit)
        {
            var p = await db.N_PREDPIs.FindAsync(_edit.Id);
            if (p == null) return;

            p.ID_VYSETRENIA = _edit.IdVysetrenia;
            p.SUKL_KOD = _edit.SuklKod;
            p.DAVKOVANIE = _edit.Davkovanie;
            p.MNOZSTVO = _edit.Mnozstvo;
            p.POZNAMKA = _edit.Poznamka;
            p.DATUM_PREDPISU = _edit.Datum;

            Notify.Success("Predpis bol upravený.");
        }
        else
        {
            db.N_PREDPIs.Add(new N_PREDPI
            {
                ID_VYSETRENIA = _edit.IdVysetrenia,
                SUKL_KOD = _edit.SuklKod!,
                DAVKOVANIE = _edit.Davkovanie,
                MNOZSTVO = _edit.Mnozstvo,
                POZNAMKA = _edit.Poznamka,
                DATUM_PREDPISU = _edit.Datum
            });

            Notify.Success("Predpis bol vytvorený.");
        }

        await db.SaveChangesAsync();
        CancelEdit();
        _tableKey++;
    }

    private async Task EditAsync(decimal id)
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        var p = await db.N_PREDPIs.FindAsync(id);
        if (p == null) return;

        _edit = new PredpisEdit
        {
            Id = p.ID_PREDPISU,
            IdVysetrenia = p.ID_VYSETRENIA,
            SuklKod = p.SUKL_KOD,
            Davkovanie = p.DAVKOVANIE,
            Mnozstvo = p.MNOZSTVO,
            Poznamka = p.POZNAMKA,
            Datum = p.DATUM_PREDPISU
        };

        _suklSearch = p.SUKL_KOD ?? "";
        _isEdit = true;
    }

    private void CancelEdit()
    {
        _isEdit = false;
        _edit = new PredpisEdit { Datum = DateTime.Today };
        _suklSearch = "";
        _suklResults.Clear();
    }

    private async Task DeleteAsync(decimal id)
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        var p = await db.N_PREDPIs.FindAsync(id);
        if (p == null) return;

        db.N_PREDPIs.Remove(p);
        await db.SaveChangesAsync();

        Notify.Success("Predpis bol zmazaný.");
        _tableKey++;
    }
}
