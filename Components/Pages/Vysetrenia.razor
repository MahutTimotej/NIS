@page "/vysetrenia"
@rendermode InteractiveServer

@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using NIS.Data
@using NIS.Data.Models
@using NIS.Services
@using System.ComponentModel.DataAnnotations

@inject IDbContextFactory<NisDbContext> DbFactory
@inject NotificationService Notify
@inject IJSRuntime JS

<style>
    .snimok-cell {
        position: relative;
    }

    .snimok-preview {
        position: absolute;
        top: -10px;
        left: 110%;
        z-index: 2000;
        background: #fff;
        border: 1px solid rgba(0,0,0,.15);
        border-radius: 8px;
        padding: 6px;
        box-shadow: 0 12px 30px rgba(0,0,0,.15);
        display: none;
    }

    .snimok-cell:hover .snimok-preview {
        display: block;
    }

    .snimok-preview img {
        max-width: 220px;
        max-height: 220px;
        display: block;
        border-radius: 4px;
    }
</style>

<div class="d-flex align-items-end justify-content-between mb-3">
    <div>
        <h2 class="mb-0">Vyšetrenia</h2>
        <div class="nis-muted small">Vytvorenie a prehľad vyšetrení.</div>
    </div>

    <button class="btn nis-btn btn-nis-primary" @onclick="OpenCreate" disabled="@_busy">
        Nové vyšetrenie
    </button>
</div>

@if (_createOpen)
{
    <div class="card-nis mb-3">
        <div class="card-header">
            <strong>Nové vyšetrenie</strong>
        </div>

        <div class="card-body">
            <EditForm Model="_create" OnValidSubmit="CreateAsync">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Pacient (ID)</label>
                        <InputNumber class="form-control" @bind-Value="_create.IdPacienta" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Lekár (ID)</label>
                        <InputNumber class="form-control" @bind-Value="_create.IdLekara" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Dátum a čas</label>
                        <InputText class="form-control" type="datetime-local" @bind-Value="_datumText" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Typ vyšetrenia</label>
                        <InputText class="form-control" @bind-Value="_create.TypVysetrenia" />
                    </div>

                    <div class="col-12">
                        <label class="form-label">Výsledok</label>
                        <InputTextArea class="form-control" rows="3" @bind-Value="_create.Vysledok" />
                    </div>

                    <div class="col-12">
                        <label class="form-label">Snímok</label>
                        <InputFile OnChange="OnFileSelected" />
                    </div>
                </div>

                <div class="mt-3 d-flex gap-2">
                    <button type="submit" class="btn nis-btn btn-nis-primary" disabled="@_busy">
                        Uložiť
                    </button>
                    <button type="button" class="btn nis-btn btn-nis-outline" @onclick="CloseCreate">
                        Zrušiť
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

<NisTable TItem="N_VYSETRENIE"
          Title="Zoznam vyšetrení"
          PageSize="50"
          Colspan="7"
          Query="Query">

    <Header>
    <th>ID</th>
    <th>Pacient</th>
    <th>Lekár</th>
    <th>Dátum</th>
    <th>Typ</th>
    <th>Výsledok</th>
    <th>Snímok</th>
    </Header>

    <Row Context="v">
        <tr>
            <td>@v.ID_VYSETRENIA</td>
            <td>@v.ID_PACIENTA</td>
            <td>@v.ID_LEKARA</td>
            <td>@v.DATUM</td>
            <td>@v.TYP_VYSETRENIA</td>
            <td class="nis-muted">@v.VYSLEDOK</td>
            <td class="snimok-cell">
                @if (v.SNIMOK != null)
                {
                    <button class="btn btn-sm btn-outline-primary"
                            @onclick="() => DownloadAsync(v.ID_VYSETRENIA)">
                        Stiahnuť
                    </button>

                    @if (v.SNIMOK_MIME != null && v.SNIMOK_MIME.StartsWith("image/"))
                    {
                        <div class="snimok-preview">
                            <img src="data:@v.SNIMOK_MIME;base64,@Convert.ToBase64String(v.SNIMOK)" />
                        </div>
                    }
                }
            </td>
        </tr>
    </Row>
</NisTable>

@code {
    private bool _createOpen;
    private bool _busy;
    private string _datumText = DateTime.Now.ToString("yyyy-MM-ddTHH:mm");

    private byte[]? _fileBytes;
    private CreateModel _create = new();

    private sealed class CreateModel
    {
        [Required] public decimal IdPacienta { get; set; }
        [Required] public decimal IdLekara { get; set; }
        [Required] public DateTime Datum { get; set; } = DateTime.Now;
        [Required] public string TypVysetrenia { get; set; } = "";
        public IBrowserFile? Snimok { get; set; }
        public string? Vysledok { get; set; }
    }

    void OpenCreate()
    {
        _create = new CreateModel();
        _datumText = DateTime.Now.ToString("yyyy-MM-ddTHH:mm");
        _fileBytes = null;
        _createOpen = true;
    }

    void CloseCreate() => _createOpen = false;

    async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        _create.Snimok = file;

        using var ms = new MemoryStream();
        await file.OpenReadStream(50 * 1024 * 1024).CopyToAsync(ms);
        _fileBytes = ms.ToArray();
    }

    IQueryable<N_VYSETRENIE> Query(NisDbContext db)
        => db.N_VYSETRENIEs.AsNoTracking();

    async Task CreateAsync()
    {
        _busy = true;
        try
        {
            _create.Datum = DateTime.Parse(_datumText);

            await using var db = await DbFactory.CreateDbContextAsync();

            db.N_VYSETRENIEs.Add(new N_VYSETRENIE
            {
                ID_PACIENTA = _create.IdPacienta,
                ID_LEKARA = _create.IdLekara,
                DATUM = _create.Datum,
                TYP_VYSETRENIA = _create.TypVysetrenia,
                VYSLEDOK = _create.Vysledok,
                SNIMOK = _fileBytes,
                SNIMOK_MIME = _create.Snimok?.ContentType,
                SNIMOK_NAZOV = _create.Snimok?.Name
            });

            await db.SaveChangesAsync();
            Notify.Success("Vyšetrenie bolo vytvorené.");
            _createOpen = false;
        }
        catch (Exception ex)
        {
            Notify.Error(ex.Message);
        }
        finally
        {
            _busy = false;
        }
    }

    async Task DownloadAsync(decimal id)
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        var v = await db.N_VYSETRENIEs.FindAsync(id);
        if (v?.SNIMOK == null) return;

        await JS.InvokeVoidAsync(
            "downloadFile",
            v.SNIMOK_NAZOV ?? $"snimok_{id}",
            v.SNIMOK_MIME ?? "application/octet-stream",
            Convert.ToBase64String(v.SNIMOK)
        );
    }
}
