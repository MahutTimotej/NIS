@page "/diagnozy"
@rendermode InteractiveServer

@using Microsoft.EntityFrameworkCore
@using NIS.Data
@using NIS.Data.Models

@inject IDbContextFactory<NisDbContext> DbFactory

<h2 class="mb-3">Diagnózy</h2>

<div class="card-nis mb-3">
    <div class="card-header fw-semibold">
        Nová diagnóza
    </div>

    <div class="card-body">
        <EditForm Model="_new" OnValidSubmit="CreateAsync">
            <DataAnnotationsValidator />

            <div class="row g-3">
                <div class="col-md-3">
                    <InputText class="form-control" placeholder="Kód" @bind-Value="_new.Kod" />
                </div>

                <div class="col-md-4">
                    <InputText class="form-control" placeholder="Názov" @bind-Value="_new.Nazov" />
                </div>

                <div class="col-md-5">
                    <InputText class="form-control" placeholder="Popis" @bind-Value="_new.Popis" />
                </div>
            </div>

            <div class="mt-3">
                <button class="btn nis-btn btn-nis-primary" type="submit">
                    Uložiť
                </button>
            </div>
        </EditForm>
    </div>
</div>

<NisTable @key="_tableKey"
          TItem="N_DIAGNOZA"
          Title="Zoznam diagnóz"
          SearchPlaceholder="Hľadať (ID, kód, názov, popis)..."
          PageSize="50"
          Colspan="5"
          Query="Query"
          Filter="Filter"
          Sort="Sort">

    <Header Context="h">
    <th>ID</th>
    <th>Kód</th>
    <th>Názov</th>
    <th>Popis</th>
    <th style="width:120px;">Akcie</th>
    </Header>

    <Row Context="d">
        <tr>
            <td>@d.ID_DIAGNOZY</td>
            <td>@d.KOD</td>
            <td class="fw-semibold">@d.NAZOV</td>
            <td class="nis-muted">@d.POPIS</td>
            <td>
                @if (_deleteId == d.ID_DIAGNOZY)
                {
                    <button class="btn btn-sm btn-danger me-1"
                            @onclick="() => ConfirmDeleteAsync(d.ID_DIAGNOZY)">
                        Áno
                    </button>
                    <button class="btn btn-sm btn-outline-secondary"
                            @onclick="CancelDelete">
                        Nie
                    </button>
                }
                else
                {
                    <button class="btn btn-sm btn-danger"
                            @onclick="() => AskDelete(d.ID_DIAGNOZY)">
                        X
                    </button>
                }
            </td>
        </tr>
    </Row>

</NisTable>

@code {
    private int _tableKey = 0;
    private decimal? _deleteId;

    private NewDiagnoza _new = new();

    private sealed class NewDiagnoza
    {
        public string Kod { get; set; } = "";

        public string Nazov { get; set; } = "";

        public string? Popis { get; set; }
    }

    IQueryable<N_DIAGNOZA> Query(NisDbContext db)
        => db.N_DIAGNOZAs.AsNoTracking();

    IQueryable<N_DIAGNOZA> Filter(IQueryable<N_DIAGNOZA> q, string t)
    {
        var s = t.ToUpper();
        return q.Where(x =>
            EF.Functions.Like(x.ID_DIAGNOZY.ToString(), $"%{t}%") ||
            EF.Functions.Like((x.KOD ?? "").ToUpper(), $"%{s}%") ||
            EF.Functions.Like((x.NAZOV ?? "").ToUpper(), $"%{s}%") ||
            EF.Functions.Like((x.POPIS ?? "").ToUpper(), $"%{s}%")
        );
    }

    IQueryable<N_DIAGNOZA> Sort(IQueryable<N_DIAGNOZA> q, string c, bool a)
        => q.OrderBy(x => x.ID_DIAGNOZY);

    private async Task CreateAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        db.N_DIAGNOZAs.Add(new N_DIAGNOZA
        {
            KOD = _new.Kod.Trim(),
            NAZOV = _new.Nazov.Trim(),
            POPIS = string.IsNullOrWhiteSpace(_new.Popis) ? null : _new.Popis.Trim()
        });

        await db.SaveChangesAsync();

        _new = new();
        _tableKey++;
    }

    private void AskDelete(decimal id) => _deleteId = id;
    private void CancelDelete() => _deleteId = null;

    private async Task ConfirmDeleteAsync(decimal id)
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        var d = await db.N_DIAGNOZAs.FindAsync(id);
        if (d != null)
        {
            db.N_DIAGNOZAs.Remove(d);
            await db.SaveChangesAsync();
        }

        _deleteId = null;
        _tableKey++;
    }
}
